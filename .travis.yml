language: cpp
os:
 - linux
notifications:
 email:
  on_success: change # [always|never|change] # default: change
  on_failure: always # [always|never|change] # default: always

compiler:
 - gcc

env:
#TODO: make Boost.Chrono optional because it was introduced in Boost 1.47 
# - CXX=g++-5   BOOST=libboost1.46-all-dev WEBSOCKETPP=OFF PEDANTIC=ON  NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release

#TODO: make boost/type_traits/is_nothrow_move_assignable.hpp optional
# - CXX=g++-5   BOOST=libboost1.48-all-dev WEBSOCKETPP=OFF PEDANTIC=ON  NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release

# - PACKAGE=g++-5   CXX=g++-5   BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=ON  NO_EXCEPTIONS=ON  NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release
# - PACKAGE=g++-5   CXX=g++-5   BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=ON  NO_EXCEPTIONS=OFF NO_RTTI=ON  TEST_INCLUDES=OFF BUILD_TYPE=Release
# - PACKAGE=g++-5   CXX=g++-5   BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=ON  NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=ON  BUILD_TYPE=Release
# - PACKAGE=g++-5   CXX=g++-5   BOOST=libboost1.54-all-dev WEBSOCKETPP=OFF PEDANTIC=ON  NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Debug
# - PACKAGE=g++-4.9 CXX=g++-4.9 BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release
# - PACKAGE=g++-4.9 CXX=g++-4.9 BOOST=libboost1.54-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Debug
# - PACKAGE=g++-4.8 CXX=g++-4.8 BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release
# - PACKAGE=g++-4.8 CXX=g++-4.8 BOOST=libboost1.54-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Debug
# - PACKAGE=g++-4.7 CXX=g++-4.7 BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Debug

#TODO: support GCC 4.7 + ancient Boost
# - PACKAGE=g++-4.7 CXX=g++-4.7 BOOST=libboost1.54-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release
# - PACKAGE=g++-4.6 CXX=g++-4.6 BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Debug
# - PACKAGE=g++-4.6 CXX=g++-4.6 BOOST=libboost1.54-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release

 - PACKAGE=clang-3.2 CXX=clang++ BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release
 - PACKAGE=clang-3.3 CXX=clang++ BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release
 - PACKAGE=clang-3.4 CXX=clang++ BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release
 - PACKAGE=clang-3.5 CXX=clang++ BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release
 - PACKAGE=clang-3.6 CXX=clang++ BOOST=libboost1.55-all-dev WEBSOCKETPP=OFF PEDANTIC=OFF NO_EXCEPTIONS=OFF NO_RTTI=OFF TEST_INCLUDES=OFF BUILD_TYPE=Release

before_install:
 - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
 - sudo add-apt-repository -y ppa:h-rayflood/llvm
 - sudo add-apt-repository -y ppa:boost-latest/ppa
 - sudo apt-get update -qq
 - sudo apt-get install -qq cmake liburiparser-dev valgrind $PACKAGE $BOOST
 - git submodule update --init --recursive

script:
 - mkdir build
 - cd build
 - cmake .. -DSILICIUM_USE_WEBSOCKETPP=$WEBSOCKETPP -DSILICIUM_TEST_INCLUDES=$TEST_INCLUDES -DSILICIUM_PEDANTIC=$PEDANTIC -DSILICIUM_NO_EXCEPTIONS=$NO_EXCEPTIONS -DCMAKE_BUILD_TYPE=$BUILD_TYPE -DSILICIUM_TESTS_RUNNING_ON_TRAVIS_CI=ON -DSILICIUM_NO_RTTI=$NO_RTTI || exit 1
 - cmake --build . -- -j2 || exit 1
 - cd test
 - if [ $NO_RTTI != "ON" ]; then
     ./unit_test || exit 1
     valgrind --leak-check=full --error-exitcode=1 ./unit_test || exit 1;
   fi
 - cd ../system_test
 - if [ $NO_RTTI != "ON" ] && [ $NO_EXCEPTIONS != "ON" ]; then
     ./system_test || exit 1
     valgrind --leak-check=full --error-exitcode=1 ./system_test || exit 1;
   fi
